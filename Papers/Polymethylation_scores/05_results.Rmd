---
output:
  html_document: default
  word_document: default
bibliography: Methylation_SmokingBib.bib
always_allow_html: true
---

```{r, echo=F, include=FALSE}
library(knitr)
knitr::knit_child(here::here("Reports", "Paper1.Rmd"))
```

```{r, echo=F, include=FALSE}
coefCI=function(df, filter_statement, my_term, si){
  my_df=df%>%
    filter(eval(parse(text = filter_statement)))%>%
    unnest(tidied)%>%
    mutate(val=paste0(round(estimate, si), ' (95%CI: ', 
                      round(conf.low, si), ', ',
                      round(conf.high, si), ')'))%>%
    filter(term==my_term)%>%
    pull(val)
  return(my_df)
}
```

# Results

## Study sample descriptive statistics

Of `r methylCohort$MethID%>%length()` samples from `r methylCohort$idnum%>%unique()%>%length()` unique participants with DNA methylation data measured on the Illumina 450K  array, `r m_obs` samples from `r n_total` participants had complete data on additional key covariates (Figure 1). There were `r n_twovisit` participants with both age 9 and age 15 DNA methylation samples. Excluded samples were similar to included samples, except that included samples were slightly more likely to be from children of African genetic ancestry and less likely to be from children of Hispanic genetic ancestry (Supplemental Table 1). In the included sample, 20% percent of the mothers reported any prenatal maternal smoking, `r round(table(modeldata_wide$m1g2_YesNoPreg)/nrow(modeldata_wide)*100)['Yes']`% reported prenatal alcohol use and `r round(table(modeldata_wide$m1g3_YesNoPreg)/nrow(modeldata_wide)*100)['Yes']`% reported prenatal drug use. The mean income to poverty ratio of mothers at birth was `r round(mean(modeldata_wide$cm1inpov), 2)`. Of the children in the analytic sample, `r round(table(modeldata_wide$cm1bsex)/nrow(modeldata_wide)*100)['1 Boy']`% were male, `r round(table(modeldata_wide$ancestry)/nrow(modeldata_wide)*100)['African ancestry']`% were of African genetic ancestry, and `r round(table(modeldata_wide$ancestry)/nrow(modeldata_wide)*100)['Hispanic ancestry']`% were of Hispanic genetic ancestry.  

We calculated several summary measures of DNA methylation, including polymethylation scores, global methylation, and epigenetic clocks. Many of the methylation summary measures were correlated with each other (Supplemental Figure 1). For example, as expected, the percent of estimated immune cells was perfectly inversely correlated with the percent of estimate epithelial cells (Pearson $rho$=`r cor(modeldata$Epithelial.cells_saliva, modeldata$Leukocytes_saliva)`; *P* value<0.0001). Our primary polymethylation score  measure, which was calculated using coefficients from a cell-type corrected regression, was very slightly correlated estimated cell-type proportion of immune cells (Pearson $rho$=`r round(cor.test(modeldata$SSnewbornCT_center, modeldata$Leukocytes_saliva)$estimate, 2)`; *P* value=`r round(cor.test(modeldata$SSnewbornCT_center, modeldata$Leukocytes_saliva)$p.value, 3)`). 

We compared epigenetic measures between the age 9 and age 15 visit among the `r n_twovisit` individuals with data from both visits (Supplemental Figure 2). The correlation across ages was strongest for the primary polymethylation score (Pearson $\rho$=`r round(cor(model_twovisit$SSnewbornCT_center_Age_9, model_twovisit$SSnewbornCT_center_Age_15), 2)`, *P* value<0.0001). The distribution of epigenetic ages shifted between the age 9 and age 15 visit, as expected (Supplemental Figure 3). Among age 9 samples, the mean estimated age from the pediatric clock was `r round(mean(modeldata_wide$pediatric_Age_9, na.rm=T))`  and the mean estimated age from the GRIM clock was `r round(mean(modeldata_wide$grim_Age_9, na.rm=T))`. Among age 15 samples, the mean estimated age from the pediatric clock was `r round(mean(modeldata_wide$pediatric_Age_15, na.rm=T))` and the mean estimated age from the GRIM clock was `r round(mean(modeldata_wide$grim_Age_15, na.rm=T))`. The distribution of estimated cell-type proportions also shifted between visits while the distribution of global methylation and polymethylation scores were more consistent (Supplemental Figure 3). 

In bivariate analyses and multivariable models, we focused on the polymethylation scores and the single top CpG site from Joubert et al, AHRR:cg05575921, as hypothesized biomarkers, and used global methylation and the pediatric clock as negative controls. 

## Bivariate associations between prenatal maternal smoking and DNA methylation summary measures

Mothers who reported smoking during pregnancy had lower income to poverty ratios than those who did not ( `r modeldata_people%>%filter(smkPreg_binary=='Yes')%>%summarise(mean(cm1inpov))%>%round(2)` vs `r modeldata_people%>%filter(smkPreg_binary=='No')%>%summarise(mean(cm1inpov))%>%round(2)`).  Mothers who smoked were more likely to report prenatal alcohol use (`r with(modeldata_people, prop.table(table(smkPreg_binary, m1g2_YesNoPreg), margin=1))[2, 2]%>%round(2)*100`% vs `r with(modeldata_people, prop.table(table(smkPreg_binary, m1g2_YesNoPreg), margin=1))[1, 2]%>%round(2)*100`%), prenatal drug use (`r with(modeldata_people, prop.table(table(smkPreg_binary, m1g3_YesNoPreg), margin=1))[2, 2]%>%round(2)*100`% vs `r with(modeldata_people, prop.table(table(smkPreg_binary, m1g3_YesNoPreg), margin=1))[1, 2]%>%round(2)*100`%) and postnatal smoking (`r with(modeldata_people, prop.table(table(smkPreg_binary, PostnatalMaternalSmokingAny), margin=1))[2, 2]%>%round(2)*100`% vs `r with(modeldata_people, prop.table(table(smkPreg_binary, PostnatalMaternalSmokingAny), margin=1))[1, 2]%>%round(2)*100`%) than mothers who did not report prenatal maternal smoking (Table 1).  Children of mothers who reported smoking during pregnancy were more likely to be of European genetic ancestry (`r round(with(modeldata_people, prop.table(table(smkPreg_binary, ancestry), margin=1))[2, 2], 2)*100`%) than children of mothers who did not (`r round(with(modeldata_people, prop.table(table(smkPreg_binary, ancestry), margin=1))[1, 2], 2)*100`%, *P* value=`r round(with(modeldata_people, chisq.test(table(smkPreg_binary, ancestry)))$p.value, 4)`). Children of mothers who reported smoking during pregnancy had higher prenatal maternal smoking polymethylation scores than children of mothers who did not at both the age 9 (`r round(t.test(SSnewbornCT_center_Age_9~smkPreg_binary, data=modeldata_wide)$estimate['mean in group Yes'], 2)` vs `r round(t.test(SSnewbornCT_center_Age_9~smkPreg_binary, data=modeldata_wide)$estimate['mean in group No'], 2)`, *P* value<0.001) and age 15 (`r round(t.test(SSnewbornCT_center_Age_15~smkPreg_binary, data=modeldata_wide)$estimate['mean in group Yes'], 2)` vs `r round(t.test(SSnewbornCT_center_Age_15~smkPreg_binary, data=modeldata_wide)$estimate['mean in group No'], 2)`, *P* value<0.001) visits (Table 1, Supplemental Table2). At age 9, children exposed to prenatal maternal smoking had lower DNA methylation at AHRR:cg05575921 (`r round(t.test(cg05575921_Age_9~smkPreg_binary, data=modeldata_wide)$estimate['mean in group Yes'], 2)*100`%) than children of non-smoking mothers (`r round(t.test(cg05575921_Age_9~smkPreg_binary, data=modeldata_wide)$estimate['mean in group No'], 2)*100`%, *P* value=`r round(t.test(cg05575921_Age_9~smkPreg_binary, data=modeldata_wide)$p.value, 2)`). At age 15, children exposed to prenatal smoking had lower DNA methylation at AHRR:cg05575921 (`r round(t.test(cg05575921_Age_15~smkPreg_binary, data=modeldata_wide)$estimate['mean in group Yes'], 2)*100`%) than children of non-smoking mothers, although this difference was not significant (`r round(t.test(cg05575921_Age_15~smkPreg_binary, data=modeldata_wide)$estimate['mean in group No'], 2)*100`% *P* value= `r round(t.test(cg05575921_Age_15~smkPreg_binary, data=modeldata_wide)$p.value, 2)`). 

 
## Multivariable associations between prenatal maternal smoking and DNA methylation summary measures

The association between prenatal maternal smoking and the polymethylation score was also observed in multivariable models  (Figure 3; Supplemental Table 2). At age 9, prenatal maternal smoke exposure was associated with a `r coefCI(global_models, "childteen=='Age 9' & predictors=='base model' & outcome=='Sustained smoking polymethylation score (newborns, cell-type controlled)'", 'smkPreg_binaryYes', 2)` standard deviation higher polymethylation score.  At age 15, prenatal maternal smoke exposure was associated with a `r coefCI(global_models, "childteen=='Age 15' & predictors=='base model' & outcome=='Sustained smoking polymethylation score (newborns, cell-type controlled)'", 'smkPreg_binaryYes', 2)` standard deviation higher polymethylation score. A consistent association was observed when stratifying to the African genetic ancestry sample (n= `r modeldata_people%>%filter(ancestry=='African ancestry')%>%nrow()`). In the African genetic ancestry sample at age 9, prenatal maternal smoking was associated with a `r coefCI(local_models, "childteen=='Age 9' & predictors=='base model' & outcome=='Sustained smoking polymethylation score (newborns, cell-type controlled)' & ancestry=='African ancestry'", 'smkPreg_binaryYes', 2)` standard deviation higher polymethylation score. The direction and magnitude of the association was similar in the European and Hispanic genetic ancestry samples at age 9, though attenuated at age 15 (Figure 3; Supplemental Tables 2). 

Prenatal maternal smoking was associated with lower methylation at AHRR:cg055975921 at age 9 (`r coefCI(global_models, "childteen=='Age 9' & predictors=='base model' & outcome=='AHRR: cg05575921'", 'smkPreg_binaryYes', 2)`) and age 15 (`r coefCI(global_models, "childteen=='Age 15' & predictors=='base model' & outcome=='AHRR: cg05575921'", 'smkPreg_binaryYes', 2)`). Associations between prenatal maternal smoking and AHRR:cg05575921 were less robust across ancestries (Figure 3). 

## Sensitivity analyses 

When also adjusting for other prenatal exposures and postnatal smoke exposure, the association between prenatal maternal smoking and the polymethylation score was very consistent (Supplemental Figure 4). The direction of the association between prenatal maternal smoking and AHRR:cg055975921 was also consistent, although no longer significant at age 15. Children exposed to postnatal smoke but not prenatal smoke did not have higher polymethylation scores than children unexposed to both postnatal and prenatal smoke.  (Supplemental Figure 5). Results were also similar when controlling for surrogate variables instead of known covariates (Supplemental Figure 6; Supplemental Table 2). 

Results were similar when using linear mixed effect models instead of age-stratified models (Supplemental Table 3 & 4). 

Results were also similar when using polymethylation scores constructed using alternative regression coefficients (see Methods, Supplemental Figure 7). The association between prenatal maternal smoking and the polymethylation score using regression coefficients from newborn cord blood with cell-type controls was the strongest.  Prenatal maternal smoking also associated with other selected *a priori* CpG sites consistently with associations reported in previous meta-analyses (Supplemental Table 2, Supplemental Figure 8). 

## Accuracy of polymethylation scores as a biomarker of prenatal maternal smoking 

Next, we compared the accuracy of different DNA methylation summary measures for classifying prenatal maternal smoking using receiver operating curves (Figure 4A; Supplemental Table 5). We considered classification when using DNA methylation summary measures alone. We also considered classification when using DNA methylation summary measures in addition to a base model of child sex, maternal income to poverty ratio at baseline, child age at methylation measurement, estimated immune cell proportion, plate from methylation processing and the first two components of genetic ancestry. When used without DNA methylation measures, these base model variables had an area under the curve (AUC) of `r rct1 %>% filter(modeltype=='Base model+No methylation' & childteen=='Age 9')%>%pull(auc)` at age 9 and `r rct1 %>% filter(modeltype=='Base model+No methylation' & childteen=='Age 15')%>%pull(auc)` at age 15.

At age 9, including the polymethylation score  significantly improved the base model accuracy (AUC: `r rct1%>%filter(modeltype=='Base model+Sustained smoking polymethylation score (newborns, cell-type controlled)'&childteen=='Age 9')%>%pull(auc)`, *P* value comparing to base model=`r rct1%>%filter(modeltype=='Base model+Sustained smoking polymethylation score (newborns, cell-type controlled)'&childteen=='Age 9')%>%pull(4)`). Similarly, including the polymethylation significantly improved the base model accuracy at age 15 (AUC:`r rct1%>%filter(modeltype=='Base model+Sustained smoking polymethylation score (newborns, cell-type controlled)'&childteen=='Age 15')%>%pull(auc)` , *P* value=`r rct1%>%filter(modeltype=='Base model+Sustained smoking polymethylation score (newborns, cell-type controlled)'&childteen=='Age 15')%>%pull(4)`). 

At age 9,the base model with the polymethylation score had a larger AUC than the base model with AHRR:cg05575921 (AUC base model+AHRR:cg05575921: `r rct1%>%filter(modeltype=='Base model+AHRR: cg05575921'&childteen=='Age 9')%>%pull(auc)`; *P* value =`r rct1%>%filter(modeltype=='Base model+AHRR: cg05575921'&childteen=='Age 9')%>%pull(5)`). At age 15, this was also true (AUC for base model+AHRR:cg05575921=`r rct1%>%filter(modeltype=='Base model+AHRR: cg05575921'&childteen=='Age 15')%>%pull(auc)`,  *P* value=`r rct1%>%filter(modeltype=='Base model+AHRR: cg05575921'&childteen=='Age 15')%>%pull(5)`). Accuracy was not improved by including polymethylation scores from age 9 and age 15 together (Figure 4B). 

## Sensitivity analyses 

Results were similar when using other coefficients as the weights in construction of the polymethylation scores. However, the AUC was always significantly higher when using the coefficients from a model which incorporated cell-type control as weights (Supplemental Table 6). 


