# Polymethylation Scores for Prenatal Maternal Smoke Exposure Persist Until Age 15 and Are Detected in Saliva

This is the code repository for the medrxiv preprint https://www.medrxiv.org/content/10.1101/2021.11.30.21267020v2

The analysis for this paper can be run using Scripts 1-4 in the Scripts folder. Figures, tables and reported results can be generated by then knitting:

either one of

- Reports/Paper1.Rmd or
- Papers/Polymethylation_scores/05_results.Rmd (which sources Reports/Paper1.Rmd but also prints out the results section of the paper) or
- Papers/Polymethylation_scores/index_paper.Rmd (which will sources 05_results.Rmd and reproduce the entire paper)

Specifically: 

1. source Scripts/01_clean_phenotype.R
2. source Scripts/02_make_methyl_summary.R
3. ---if running SVA analysis: sbatch UsefulCode/SVAbatch.pbs, which will submit Scripts/03_sva_variables.R ---
4. source Scripts/04_summary_methyl_models.R
5. knit Papers/PolymethylationScores/05_results.Rmd


##############################################################################################################################################################################

# Detailed description of code, inputs and outputs

## Scripts folder

### 01_clean_phenotype.R

This script takes in the full phenotype data for Fragile Families, the methylation subset data and the genetic PCs of ancestry data. 

This data is merged, the variables are labeled, some variables are re parameterized and the various filters for missing data are instituted (and recorded into individual 
datasets)

At the end, the complete case dataset is saved. Also, all intermediete data files are saved. 

#### inputs -- 

#Phenotype data

1. fullpheno.rds - this is the dataset with the Fragile Families data
2. FFMetadata_v07.csv - this is a data dictionary for variables in fullpheno.rds

#Methylation QC data

3. pd_qc.rds - this is a dataset from Jonah with DNA methylation quality filtering criteria
4. isee_pollutionpegs_newvars_5.6.2021.csv - this is the dataset used in the polymethylation scores + air pollution paper. It is needed because it corrects several mislabelled sex observations. 
5. Methylation_450K_array_batch_information.csv - this is the dataset with information on array, sample plate etc

#Genetic PCs data

4. pcs_n50.eigenvec - global PC of genetic data (whole subcohort)
5. FFCWDNA_African_n1640.csv - PCs rerun within African genetic ancestry samples
6. FFCWDNA_European_n475.csv - PCs rerun within European genetic ancestry samples
7. FFCWDNA_Hispanic_n959.csv - PCs rerun within Hispanic genetic ancestry samples

#### Main outputs -- 

1. completecase: completeCasepheno.Rdata - this is a dataset of complete case (i.e. no missing data) with all the phenotype data needed for this analysis, parameterized as will be used in main analysis
post exclusions
2. myFF - this is a dataset with all the phenotype data needed for this analysis, parameterized as will be used in main analysis. pre exclusions

#### Other outputs -- 

1. MissingPC.Rdata - samples without PC data
2. Intermediate datasets for excluding participants - these get used to make Figure 1 of exclusion Ns

### 02_make_methyl_summary.R

This script takes in the beta methylation matrix and associated phenotype data and calculates or merges in summary methylation measures of interest including; 

1) Global and region-stratified mehylation means 
2) Selected a priori CpGs 
3) Polymethylation scores
4) methyation clocks
5) cell type proportions

#### inputs -- 

1. betaqc.rds - beta matrix 
2. PMC4833289_SuppFile2CpGs.cs - Supplemental file with the regression coefficients for constructing polymethylation scores (Joubert 2016)
3. ffcw_n1776_8clocks.csv - dna methylation epigenetic clocks for Fragile Families
4. dnampackyrs_fromgrimoutput.csv - dna pack years from grim subcomponent f
-- note - the code can be run using the pre-calculated clocks or recalculating the clocks independently. to recalculate clocks independently, would need: --
5. pd_qc.rds - this is a dataset with DNA methylation quality filtering criteria
6. clocks_coefs - folder with all the clock coefficients 

#### code inputs -- 

1. 'UsefulCode'/'makePolyEpiScores.R' - function for calculating polymethylation scores

#### outputs -- 

1. methyldata: allmethyl.Rdata - this dataset has the phenotype AND methylation summary variables for the entire methylation subcohort (all samples with methylation data)
2. completecase: completeCasemethyl: this dataset has the phenotype AND methylation summary variables only for the complete case subset of samples.
It also has zscore standardized polymethylation score variables (zscored using only complete case subset of samples)

### 03_sva_variables.R

This script takes in the methylation beta matrix and the complete case pheno dataset and calculates surrogate variables. 
This takes >1 day to run, so it is submitted to the Great Lake cluster using the companion script UsefulCode/SVAbatch.pbs

#### inputs -- 

1. betaqc.rds - beta matrix from Jonah with 423668 
2. completeCasepheno.Rdata - this is a dataset of complete case (i.e. no missing data) with all the phenotype data needed for this analysis, parameterized as will be used in main analysis
post exclusions. created from script 01_clean_phenotype_data.R

#### code inputs -- 

1. 'UsefulCode'/'SVAbatch.pbs' - bash script to submit sva analysis

#### outputs -- 

1. svNone.Rds sv.vNone (v refers to variance filter, i.e. this was run on all CpGs, no variance filter instituted). - contains surrogate variables for samples

### 04_summary_methyl_models.R

This script takes in the complete case data and runs various multivariable models for the main analysis and sensitivity analysis 

#### inputs -- 

1. completeCasemethyl.Rdata - complete case data with methylation data from 02_make_methyl_summary.R
2. svNone.Rds - surrogate variables from 03_sva_variables.R

#### outputs -- 

1. modeldata completeCaseSVA.Rdata - complete case data with surrogate variables merged in 
2. methylation_summarymodels.Rdata - r data object with several dataframes of tidied model output 

    a. 'long_global_roc', reversed models (i.e. prenatal maternal smoking as outcoem NOT main predictor) w/ ROC (not stratified by visit or ancestry)
    
    b. 'local_roc', - reversed models (i.e. prenatal maternal smoking as outcome NOT main predictor) w/ ROC curves (stratified by ancestry AND visit)
    
    c. 'global_roc', - reversed models (i.e. prenatal maternal smoking as outcome NOT main predictor) w/ ROC curves (stratified by visit NOT stratified by ancestry)
    
    d. 'longitudinal_local_models', - linear mixed effect models (stratified by ancestry)
    
    e. 'longitudinal_global_models', - linear mixed effect models (not stratified by ancestry)
    
    f. 'local_models', - cross-sectional models run in age 9 and age 15 visits separately (stratified by ancestry)
    
    g. 'global_models' - cross-sectional models run in age 9 and age 15 visits separately (but not stratified by ancestry)

#########Stop at 04 for polymethylation scores paper
 
