---
title: "Polymethylation scores results"
author: "F blostein"
date: "9/30/2021"
output:
  html_document:
    code_folding: show
    highlight: tango
    number_sections: no
    theme: sandstone
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message=FALSE)

library(ggplot2)
library(kableExtra)
library(ggpubr)
library(tidyr)
library(stringr)
library(dplyr)
library(compareGroups)
library(kableExtra)
library(haven)
library(sjlabelled)
library(matchmaker)
library(EpiDISH)
library("PerformanceAnalytics")
library(DescTools)
library(purrr)
library(broom)
library(broom.mixed)
library(ggplot2)
library(multcomp)
library(ggpubr)
library(cowplot)
library(geepack)
library(lme4)
library(pROC)
library(lmerTest)
library(stringr)
library(sva)
```

```{r temp read n data}
codedir=''
```

```{r future run scripts, cache=T}

source('/nfs/turbo/bakulski1/People/blostein/FF_methylation/Code/Scripts/03_summary_methyl_models.R')
```

```{r plotting variables}
theme_set(theme_classic())
```

```{r}
n_total=modeldata %>% dplyr::select(id)%>%unique()%>%nrow()
n_obs=modeldata%>%nrow()


my_round=function(x, d){
  y=c()
  d_orig=d
  for(i in 1:length(x)){
    d=d_orig
    while(round(x[i], d)==0){
    d=d+1
    }
    y[i]=round(x[i], d)
  }
  return(y)
}
```

# Coding tasks 

- X replace epidish cell estimation with ewastools Middleton

- check with jonah about final sample size and exclusions
- determine what to do w/ 1 sample missing clock data (related to above)
- rerun clocks i plan on using on all samples 

- make this an entire story line, combined supplemental and non supplemental 

# Target journal and deadline 

[Clinical epigenetics](https://www.biomedcentral.com/collections/epibio): Special issue on biomarkers; due date December 1st
 >Epigenetic biomarkers have significantly contributed to improved understanding of the origins and progression of disease.  Moreover, increasing evidence shows that epigenetic biomarkers have potential for personalized medicine. However, routine use of epigenetic biomarkers in in-vitro diagnostics (IVD) is lagging behind the discoveries of new biomarkers. In this thematic series of Clinical Epigenetics, we discuss current progress in development of epigenetic biomarkers for clinical use in common complex diseases of ageing and welcome both original research and reviews.
The sections of the collection include:
  - Types of epigenetic biomarkers and readiness for IVD use
    - DNA methylation as biomarker
    - Histone modification as biomarker
    - Upcoming field of circulating free nucleosomes as biomarker
    - Progress towards clinical use of biomarker
  - *Biomarkers of environmental exposures and causality of the biomarker*
  - Disease predisposition biomarkers
  - Biomarkers used for disease detection
  - Clinical disease prevention and management: predictive and prognostic
  - Monitoring of chronic disease
  - *Single versus multiple biomarkers and risk scores*
  - Major stages of clinical validation of the biomarker
  - Biomarker detection technologies suitable for IVD use and significance of bioinformatics
  - Ethics and regulatory aspects of IVD epigenetic biomarkers

# Figure 1 - CONSORT Diagram

# Supplemental Table 1 - Comparison of 450K subsample to Fragile Families cohort

# Supplemental Figure 1 - Cell type proportion estimation

# Supplemental Figure 2 - Choice of beta methylation transformation 

# Supplemental Figure 3 - Distribution and correlation of methylation summary measures

#Supplemental Figure 4 - Change in methylation summary measures between visits

# Figure 2: Polymethylation scores are correlated and stable between age 9 and age 15 in a diverse sample of `r n_total`US children 

```{r change in scores time, fig.width=12}

outcome_labels=c('Global methylation', 'Pediatric clock', 'AHHR: cg05575921', 'Polymethylation score \n (newborn, mean centered)', 'Polymethylation score  \n (older children, mean centered')
names(outcome_labels)=c('globalmethylation', 'pediatric', 'cg05575921', 'SSnewbornCT_center','SSolder_center')

fig2a=modeldata%>%
  dplyr::select(idnum, childteen, SSolder_center, SSnewbornCT_center, 
                cg05575921, globalmethylation, pediatric)%>%
  pivot_longer(cols=c(globalmethylation, pediatric, SSnewbornCT_center, SSolder_center, cg05575921),
               names_to='Methylation summary measure type',
               values_to='Methylation summary measure')%>%
  pivot_wider(names_from=childteen, 
              values_from=`Methylation summary measure`)%>%
  mutate(meth_f=factor(`Methylation summary measure type`, 
                       levels=c('SSnewbornCT_center', 'SSolder_center', 
                                'cg05575921',  'globalmethylation', 'pediatric')))%>%
  ggplot(aes(x=C, y=T))+geom_point()+stat_cor()+geom_smooth(method=lm)+theme_classic()+
  scale_x_continuous('Age 9 score')+scale_y_continuous('Age 15 score')+
  facet_wrap(~meth_f, scales='free', labeller = labeller(meth_f=outcome_labels), nrow=1)

fig2b=modeldata%>%
  dplyr::select(idnum, childteen, SSolder_center, SSnewbornCT_center, 
                cg05575921, globalmethylation, pediatric)%>%
  pivot_longer(cols=c(globalmethylation, pediatric, SSnewbornCT_center, SSolder_center, cg05575921),
               names_to='Methylation summary measure type', 
               values_to='Methylation summary measure')%>%
  pivot_wider(names_from=childteen,
              values_from=`Methylation summary measure`)%>%
  mutate(meth_f=factor(`Methylation summary measure type`, 
                       levels=c('SSnewbornCT_center', 'SSolder_center', '
                                cg05575921',  'globalmethylation', 'pediatric')),
         diff=T-C)%>%
  ggplot(aes(x=diff))+geom_histogram()+
  facet_wrap(~meth_f, scales='free_x', labeller = labeller(meth_f=outcome_labels), nrow=1)+
  theme_classic()+xlab('Difference in measure (Age 15- Age 9)')+
  geom_vline(aes(xintercept=0), color='red', linetype=2)+geom_rug()

plot_grid(fig2a, fig2b, nrow=2, align = 'v', axis = 'lr')

```


# Table 1: Bivariate associations between prenatal maternal smoking, DNA methylation summary measures and important covariates among a diverse sample of 

```{r temp relabel varables}
set_label(modeldata$cg05575921)<-'AHHR: cg05575921'
set_label(modeldata$SmkAtVisitPastmonth)<-'Past month maternal/primary caregiver smokin (pack/day)'
set_label(modeldata$PostnatalMaternalSmokingAny)<-'Any maternal postnatal smoking when child 1 and 5 years of age'
modeldata$childteen=factor(case_when(modeldata$childteen=='C'~'Age 9', 
                              modeldata$childteen=='T'~'Age 15'), levels=c('Age 9', 'Age 15'))
```


```{r bivariate table}
export2md(strataTable(createTable(compareGroups(smkPreg_binary~globalmethylation+pediatric+SSnewbornCT_center+cg05575921+Epi+Fib+IC+ChildAgeComposite+cm1inpov+ancestry+cm1bsex+m1g2_YesNoPreg+m1g3_YesNoPreg+PostnatalMaternalSmokingAny+SmkAtVisitPastmonth, data=modeldata)), 'childteen'))
```


#Supplemental Table XX - Bivariate associations between prenatal maternal smoking and covariates in ancestry strata



# Supplemental Table XX: Associations between prenatal maternal smoking and DNA methylation summary measures in multivariable models among `r n_total` US children

```{r}
my_main_outcomes=c('AHHR: cg05575921', 'Sustained smoking polymethylation score (newborns, cell-type controlled)', 'Sustained smoking polymethylation score (older children)', 'Pediatric clock', 'Global methylation')

my_names=c('Methylation measure', paste0(c(paste(c('Age 9 model \n n=', 'Age 15 model \n n='), modeldata%>%group_by(childteen)%>%summarise(n=n())%>%pull(n)), paste0('Longitudinal models <br> n=', n_total)), '<br> Beta (95% CI); p-value'))

tb2=rbind(global_models, longitudinal_global_models %>% mutate(childteen='Longitudinal'))%>%filter(predictors=='secondhand smoke exposure model')%>%filter(outcome %in% my_main_outcomes)%>%unnest(tidied)%>%filter(term=='smkPreg_binaryYes')%>%mutate(estimate=paste0(my_round(estimate, 2), ' (', my_round(conf.low, 2), ', ', my_round(conf.high, 2), '); ', signif(p.value, 2)))%>%dplyr::select(childteen, outcome, estimate)%>%pivot_wider(names_from=childteen, values_from=c(estimate))
names(tb2)=my_names

tb2%>%kable(., escape=F)%>%kable_minimal()%>%
  kableExtra::scroll_box(width = "100%")%>% footnote(general = "All models adjusted for:child sex, mother income to poverty ratio at birth, epithelial and immune cell proportions (estimated from methylation data), maternal other drug and other alcohol use during pregnancy, batch of array, genetic ancestry (1st two principal components of genetic data), postnatal smoke exposure (any postnatal maternal smoking and maternal packs per day in month prior to visit).")%>%kable_styling(font_size = 10)
```

```{r, width=11}
#alternatively 
my_names=c('Methylation measure', paste0(c(paste0(paste0('Unstratified <br> n=', n_total), footnote_marker_alphabet(1, 'html')), paste0(modeldata%>%group_by(ancestry)%>%dplyr::select(ancestry, idnum)%>%unique()%>%summarise(n=n())%>%transmute(label=paste0(ancestry, ' <br> n=', n))%>%pull(label), footnote_marker_alphabet(2, 'html'))), '<br> Beta (95% CI); p-value'))

tb2=rbind(longitudinal_global_models %>% mutate(ancestry='Unstratified'), longitudinal_local_models%>%dplyr::select(-data))%>%filter(predictors=='secondhand smoke exposure model')%>%filter(outcome %in% my_main_outcomes)%>%unnest(tidied)%>%filter(term=='smkPreg_binaryYes')%>%mutate(estimate=paste0(my_round(estimate, 2), ' (', my_round(conf.low, 2), ', ', my_round(conf.high, 2), ') p=', signif(p.value, 2)))%>%dplyr::select(ancestry, outcome, estimate)%>%pivot_wider(names_from=ancestry, values_from=c(estimate))

names(tb2)=my_names

tb2%>%kable(., escape=F)%>%kable_minimal()%>%
  kableExtra::scroll_box(width = "100%")%>% footnote(alphabet =  c("Model adjusted for:child sex, mother income to poverty ratio at birth, epithelial and immune cell proportions (estimated from methylation data), maternal other drug and other alcohol use during pregnancy, batch of array, genetic ancestry (1st two principal components of genetic data), postnatal smoke exposure (any postnatal maternal smoking and maternal packs per day in month prior to visit).", "Models adjusted as in (a) but principal components of genetic ancestry rerun within ancestry strata and first two components from these stratified principal components analyses used"))%>%kable_styling(font_size = 10)

```


# Figure 3 - Polymethylation scores are associated with prenatal maternal smoke exposure consistently across age and ancestry group in a sample of `r n_total` US children

```{r, fig.width=12}
my_outcomes=c('Global methylation', 'Pediatric clock', 'AHHR: cg05575921', 'Sustained smoking polymethylation score (newborns, cell-type controlled)')

outcome_labels=c('Global methylation', 'Pediatric clock', 'AHHR: cg05575921',  'Polymethylation score \n (newborn, mean centered)')

all_models=rbind(local_models, global_models%>%mutate(ancestry='Unstratified'))

data_text=all_models%>%
  mutate(n=map_dbl(data, nrow), n=paste0('n=', n), x=-0.25)%>%
  unnest(tidied)%>%
  filter(outcome=='Sustained smoking polymethylation score (newborns, cell-type controlled)' & term=='smkPreg_binaryYes'& predictors=='secondhand smoke exposure model')%>%mutate(outcome_f=outcome)
  
names(outcome_labels)=my_outcomes

all_models%>%
  mutate(n=map_dbl(data, nrow), n=paste0('n=', n))%>%
  unnest(tidied)%>%
  filter(term=='smkPreg_binaryYes' & predictors=='secondhand smoke exposure model')%>%
  filter(outcome%in% my_outcomes)%>%
    mutate(outcome_f=factor(outcome, levels=rev(my_outcomes)))%>%
  ggplot(aes(x=estimate, xmin=conf.low, xmax=conf.high, color=factor(age, rev(levels(age))), y=ancestry))+
  geom_point(position = position_dodge(width = 1))+
  geom_errorbarh(height=0.1, position = position_dodge(width = 1))+
  facet_grid(.~outcome_f, scales='free_x', labeller = labeller(outcome_f=outcome_labels))+
  geom_vline(xintercept=0, color='red', linetype="dashed", alpha=0.5)+
  geom_text(data=data_text, aes(x=x,label=n), position=position_dodge(width = 1), hjust=0.05)+
  theme_classic()+
  theme(text = element_text(size=16))+theme(legend.position = 'bottom')+
  scale_color_discrete('', limits=c('Age 9', 'Age 15'))+
  scale_x_continuous('Coefficient for prenatal maternal smoking + 95% CI')+
  scale_y_discrete('', limits=c('European ancestry', 'Hispanic ancestry', 'African ancestry', 'Unstratified'))+scale_color_manual('', values=c('black', 'darkgrey'))
```


# Supplemental Figure XX: Surrogate variable associations with known covariates

# Supplemental Table XX: Surrogate variable models 

# Figure 4 - Polymethylation scores more accurately delineate prenatal smoke exposure status than non-targeted DNA methylation summary measures and *a priori* CpGs 

```{r, fig.width=10}

names(my_outcomes)=c( 'globalmethylation', 'pediatric','cg05575921', 'SSnewbornCT_center')
my_outcomes=c('Global methylation', 'Pediatric clock', "AHHR: cg05575921", 'Polymethylation score \n (newborn, mean centered)')

fig4a= global_roc%>%
  dplyr::select(predictors, covariates, methylation, childteen, test)%>%
  mutate(modeltype=ifelse(str_detect(predictors, '\\+'), covariates, 'No covariates'))%>%
  unnest(test) %>% 
  filter(str_detect(methylation, 'SSnewbornCT|cg055|global|pediatric') &
           covariates=='')%>%
  ggplot(aes(x=spec, y=sens, color=methylation))+geom_line()+
  facet_wrap(childteen~., labeller=labeller(childteen=age_labels), nrow=1)+
  scale_color_discrete('', labels=my_outcomes)+
  theme_classic()+theme(legend.position = 'right')+guides(color=guide_legend(nrow=2, byrow=TRUE))+
  geom_abline(intercept=1, slope=-1, color='black')+
  xlab('Specificity')+ylab('Sensitivity')+
  theme(legend.position='bottom')+ coord_fixed()

fig4b=global_roc%>%
  dplyr::select(covariates, methylation, childteen, test)%>%unnest(test) %>% 
  filter(str_detect(methylation, 'SSnewbornCT') 
         & covariates=='')%>%
  rbind(long_global_roc%>% 
          mutate(childteen='C+T', methylation=gsub('_C.*', '', methylation))%>%
          dplyr::select(covariates, methylation, childteen, test)%>%
          unnest(test) %>% 
          filter(str_detect(methylation, 'SSnewbornCT') 
                 & covariates==''))%>%
  ggplot(aes(x=spec, y=sens, color=childteen, linetype=childteen))+geom_line(size=2)+
  facet_wrap(~methylation, labeller = labeller(methylation=c('SSnewbornCT_center'='Polymethylation score, \n newborn mean centered')))+
  scale_color_discrete(labels=my_outcomes)+
  theme_classic()+theme(legend.position = 'right')+guides(color=guide_legend(nrow=2,byrow=TRUE))+
  geom_abline(intercept=1, slope=-1, color='black')+
  scale_color_grey('', labels=c('Age 9 only', 'Age 9 & 15', 'Age 15 only'))+
  scale_linetype('', labels=c('Age 9 only', 'Age 9 & 15', 'Age 15 only'))+
  xlab('Specificity')+ylab('Sensitivity')+
  theme(legend.position='bottom')+ coord_fixed()

cowplot::plot_grid(fig4a, fig4b, labels=c('A', 'B'), nrow=1, rel_widths=c(0.65, 0.35), align='h', axis='t')


```

add p value comparing base model to adding in curves 

# Question for group: add EWAS results to this paper

- Arguments in favor: recent paper in Clinical Epigenetics included both 
- Arguments against: enough here for a compellling story; deadline of December 1st; submit and if asked for we have it available. 

# Cross sectional EWAS results: 

# Longitudinal EWAS results 

# METAL meta-analysis of 450K + EPIC chip data